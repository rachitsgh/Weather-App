var crs = require("..");
var Domain  =  crs.Domain,Builder  =  crs.Builder;
var db = require("./db");
var b = new Builder();
b.bindDB(db);

var MyAggreType = {

	typeName:"MyAgg",
	
	methods:{
		changeName:function(name){
			this.$data("name",name);
			this.$publish("changename",name);
		}
	},
	
	init:function(data){
		data.createTime = new Date().getTime();
		return data;
	}
	
}

b.bindEventHandle(false,"MyAgg","changename",function(event){
	console.log("name ------= " + event.data);
});

b.bindEventHandle(false,"change",function(event){
	var self = this;
	var mydb = require("./db");
	mydb.all(function(a){
		
		for(var k in a){
				if(k){
				console.log(k + '2323')
				var obj = a[k];
				var Agg = self.$getAggreType("MyAgg");
				Agg.get(obj.id,function(d){
					console.log(d)
				})
				}
		}
	})
	console.log("change name -------- = " + event.data);
});


b.bindAggreType(MyAggreType.typeName,MyAggreType.init,MyAggreType.methods);

b.bindCommandHandle("changeName",function(cmd){
	var T = this.$getAggreType("MyAgg");
	var t = new T({name:'leo'});
	t.changeName("haha");
});




var domain = new Domain(b);

domain.exec("changeName");


